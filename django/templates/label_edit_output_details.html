{% extends "label_edit.html" %}
{% load bootstrap %}
{% load i18n %}
{% block label_edit_content %}

{% if action == "output-details" %}
  {% if form.instance.type == "output" %}

  <!-- BIP-329 Fields Status Alert (right after spent status in parent template) -->
  {% if missing_fields %}
  <div class="bd-callout bd-callout-info">
    <strong>Missing BIP-329 fields:</strong>
    {% for field in missing_fields %}
      <span class="badge bg-warning text-dark">{{ field }}</span>
    {% endfor %}
    <br><small>Click the button below to populate from OutputStat data.</small>
  </div>
  {% else %}
  <div class="bd-callout bd-callout-good">
    <strong>âœ“ All fields populated!</strong> This label has all applicable BIP-329 fields filled.
  </div>
  {% endif %}

  <!-- Consolidated Output Details Card -->
  <div class="card mb-3">
    <div class="card-header">
      <h5>Output Details & BIP-329 Fields</h5>
    </div>
    <div class="card-body">
      <table class="table table-borderless">
        <tr>
          <td style="width: 30%;"><strong>Output ref:</strong></td>
          <td><tt>{{ label.ref }}</tt></td>
        </tr>
        <tr>
          <td><strong>Network:</strong></td>
          <td>{{ output.get_network_display }}</td>
        </tr>
        <tr>
          <td><strong>Spent status:</strong></td>
          <td>{{ output.get_spent_status }}</td>
        </tr>
        <tr class="table-light">
          <td colspan="2"><strong>BIP-329 Fields:</strong></td>
        </tr>
        <tr>
          <td><strong>value:</strong></td>
          <td>
            {% if label.value %}
              <tt>{{ label.value }}</tt> sats
            {% else %}
              <span class="text-muted">{{ output.value }} sats (available from OutputStat)</span>
            {% endif %}
          </td>
        </tr>
        <tr>
          <td><strong>height:</strong></td>
          <td>
            {% if label.height %}
              <tt>{{ label.height }}</tt>
            {% else %}
              <span class="text-muted">{{ output.confirmed_at_block_height }} (available from OutputStat)</span>
            {% endif %}
          </td>
        </tr>
        <tr>
          <td><strong>time:</strong></td>
          <td>
            {% if label.time %}
              <tt>{{ label.time }}</tt>
            {% else %}
              <span class="text-muted">{{ output_block_time_utc }} UTC (available from OutputStat)</span>
            {% endif %}
          </td>
        </tr>
        {% if output.next_input_attributes %}
        <tr class="table-light">
          <td colspan="2"><strong>Fee Estimation:</strong></td>
        </tr>
        <tr>
          <td colspan="2">
            {{ output.next_input_attributes }}
            {% if output.next_input_attributes.input_n %}
              <br><small>Assuming {{ output.next_input_attributes.input_m }}-of-{{ output.next_input_attributes.input_n }} multisig</small>
            {% endif %}
          </td>
        </tr>
        {% endif %}
      </table>

      <!-- Fill Button (only show if fields are missing) -->
      {% if missing_fields %}
      <form method="post" action="{% url 'fill_output_fields_action' label_id=label.id %}">
        {% csrf_token %}
        <button type="submit" class="btn btn-primary">
          <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-arrow-down-square" viewBox="0 0 16 16">
            <path fill-rule="evenodd" d="M15 2a1 1 0 0 0-1-1H2a1 1 0 0 0-1 1v12a1 1 0 0 0 1 1h12a1 1 0 0 0 1-1V2zM0 2a2 2 0 0 1 2-2h12a2 2 0 0 1 2 2v12a2 2 0 0 1-2 2H2a2 2 0 0 1-2-2V2zm8.5 2.5a.5.5 0 0 0-1 0v5.793L5.354 8.146a.5.5 0 1 0-.708.708l3 3a.5.5 0 0 0 .708 0l3-3a.5.5 0 0 0-.708-.708L8.5 10.293V4.5z"/>
          </svg>
          Fill Missing BIP-329 Fields from OutputStat
        </button>
      </form>
      {% endif %}
    </div>
  </div>

  {% endif %}
{% endif %}
{% endblock %}
